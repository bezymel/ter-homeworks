# Домашнее задание к занятию «Управляющие конструкции в коде Terraform»

### Цели задания

1. Отработать основные принципы и методы работы с управляющими конструкциями Terraform.
2. Освоить работу с шаблонизатором Terraform (Interpolation Syntax).

------

### Чек-лист готовности к домашнему заданию

1. Зарегистрирован аккаунт в Yandex Cloud. Использован промокод на грант.
2. Установлен инструмент Yandex CLI.
3. Доступен исходный код для выполнения задания в директории [**03/src**](https://github.com/netology-code/ter-homeworks/tree/main/03/src).
4. Любые ВМ, использованные при выполнении задания, должны быть прерываемыми, для экономии средств.

------

### Внимание!! Обязательно предоставляем на проверку получившийся код в виде ссылки на ваш github-репозиторий!
Убедитесь что ваша версия **Terraform** =1.5.Х (версия 1.6 может вызывать проблемы с Яндекс провайдером)
Теперь пишем красивый код, хардкод значения не допустимы!
------

### Задание 1

1. Изучите проект.
2. Заполните файл personal.auto.tfvars.
3. Инициализируйте проект, выполните код. Он выполнится, даже если доступа к preview нет.

Примечание. Если у вас не активирован preview-доступ к функционалу «Группы безопасности» в Yandex Cloud, запросите доступ у поддержки облачного провайдера. Обычно его выдают в течение 24-х часов.

Приложите скриншот входящих правил «Группы безопасности» в ЛК Yandex Cloud или скриншот отказа в предоставлении доступа к preview-версии.

### Ответ 1

![image](https://github.com/bezymel/ter-homeworks/assets/129361495/d7b18670-4a38-402e-891f-4feca35146f2)
![image](https://github.com/bezymel/ter-homeworks/assets/129361495/8e6c7cb3-e3dc-45c4-8408-9f89ee82d809)
![image](https://github.com/bezymel/ter-homeworks/assets/129361495/68e0d9ef-5519-45bd-b006-d7a1bba809fe)
![image](https://github.com/bezymel/ter-homeworks/assets/129361495/c6c4a19e-6829-4417-b5de-b6c6883c786b)

------

### Задание 2

1. Создайте файл count-vm.tf. Опишите в нём создание двух **одинаковых** ВМ  web-1 и web-2 (не web-0 и web-1) с минимальными параметрами, используя мета-аргумент **count loop**. Назначьте ВМ созданную в первом задании группу безопасности.(как это сделать узнайте в документации провайдера yandex/compute_instance )
2. Создайте файл for_each-vm.tf. Опишите в нём создание двух ВМ для баз данных с именами "main" и "replica" **разных** по cpu/ram/disk_volume , используя мета-аргумент **for_each loop**. Используйте для обеих ВМ одну общую переменную типа:
```
variable "each_vm" {
  type = list(object({  vm_name=string, cpu=number, ram=number, disk_volume=number }))
}
```  
При желании внесите в переменную все возможные параметры.

4. ВМ из пункта 2.1 должны создаваться после создания ВМ из пункта 2.2.
5. Используйте функцию file в local-переменной для считывания ключа ~/.ssh/id_rsa.pub и его последующего использования в блоке metadata, взятому из ДЗ 2.
6. Инициализируйте проект, выполните код.

### Ответ 2

![image](https://github.com/bezymel/ter-homeworks/assets/129361495/63b50649-25e6-4906-bc59-97bcc47625ac)
![image](https://github.com/bezymel/ter-homeworks/assets/129361495/78718c60-7a66-44b9-bbf3-f38dfb9e830c)
![image](https://github.com/bezymel/ter-homeworks/assets/129361495/2698ea14-266e-48da-a9cf-cbd8d6ae0e19)
![image](https://github.com/bezymel/ter-homeworks/assets/129361495/04100499-1207-40bd-b9bc-cd6f32dfcd66)


------

### Задание 3

1. Создайте 3 одинаковых виртуальных диска размером 1 Гб с помощью ресурса yandex_compute_disk и мета-аргумента count в файле **disk_vm.tf** .
2. Создайте в том же файле **одиночную**(использовать count или for_each запрещено из-за задания №4) ВМ c именем "storage"  . Используйте блок **dynamic secondary_disk{..}** и мета-аргумент for_each для подключения созданных вами дополнительных дисков.

### Ответ 3

Создал файл и добавил конфигурацию:
![image](https://github.com/bezymel/ter-homeworks/assets/129361495/cb31ea31-83a9-4e4e-9051-8046bf570633)
![image](https://github.com/bezymel/ter-homeworks/assets/129361495/f59f09fc-79fc-4366-b5ef-68a3a21048b0)
![image](https://github.com/bezymel/ter-homeworks/assets/129361495/ceb92f4d-0144-4ff9-a1eb-107d5e40d956)
![image](https://github.com/bezymel/ter-homeworks/assets/129361495/3252a388-1121-4408-b0ba-fc3662b186ba)
![image](https://github.com/bezymel/ter-homeworks/assets/129361495/5ca7d707-95ce-4d3d-88f0-ebc0d2cf7cc5)


------

### Задание 4

1. В файле ansible.tf создайте inventory-файл для ansible.
Используйте функцию tepmplatefile и файл-шаблон для создания ansible inventory-файла из лекции.
Готовый код возьмите из демонстрации к лекции [**demonstration2**](https://github.com/netology-code/ter-homeworks/tree/main/03/demo).
Передайте в него в качестве переменных группы виртуальных машин из задания 2.1, 2.2 и 3.2, т. е. 5 ВМ.
2. Инвентарь должен содержать 3 группы и быть динамическим, т. е. обработать как группу из 2-х ВМ, так и 999 ВМ.
3. Добавьте в инвентарь переменную  [**fqdn**](https://cloud.yandex.ru/docs/compute/concepts/network#hostname).
``` 
[webservers]
web-1 ansible_host=<внешний ip-адрес> fqdn=<полное доменное имя виртуальной машины>
web-2 ansible_host=<внешний ip-адрес> fqdn=<полное доменное имя виртуальной машины>

[databases]
main ansible_host=<внешний ip-адрес> fqdn=<полное доменное имя виртуальной машины>
replica ansible_host<внешний ip-адрес> fqdn=<полное доменное имя виртуальной машины>

[storage]
storage ansible_host=<внешний ip-адрес> fqdn=<полное доменное имя виртуальной машины>
```
Пример fqdn: ```web1.ru-central1.internal```(в случае указания имени ВМ); ```fhm8k1oojmm5lie8i22a.auto.internal```(в случае автоматической генерации имени ВМ зона изменяется). нужную вам переменную найдите в документации провайдера или terraform console.
4. Выполните код. Приложите скриншот получившегося файла. 

Для общего зачёта создайте в вашем GitHub-репозитории новую ветку terraform-03. Закоммитьте в эту ветку свой финальный код проекта, пришлите ссылку на коммит.   
**Удалите все созданные ресурсы**.

### Ответ 4

1. Добавил файлы;
2. Отредактировал конфигурацию;
3. Выполнил команду terraform init -upgrade;
4. Запустил код

![image](https://github.com/bezymel/ter-homeworks/assets/129361495/068e8af6-22db-477c-a4ed-6ad4a2c254bc)
![image](https://github.com/bezymel/ter-homeworks/assets/129361495/9d53b65e-0a3d-4133-9378-4d9f19504774)
![image](https://github.com/bezymel/ter-homeworks/assets/129361495/0a093315-2f59-48f1-9d28-73ecfcca9952)
![image](https://github.com/bezymel/ter-homeworks/assets/129361495/fde5dde5-3f98-4da8-a6fa-df1208c267c0)

------

### Критерии оценки

Зачёт ставится, если:

* выполнены все задания,
* ответы даны в развёрнутой форме,
* приложены соответствующие скриншоты и файлы проекта,
* в выполненных заданиях нет противоречий и нарушения логики.

На доработку работу отправят, если:

* задание выполнено частично или не выполнено вообще,
* в логике выполнения заданий есть противоречия и существенные недостатки. 


